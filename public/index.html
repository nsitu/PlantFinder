<!DOCTYPE html>
<html>
<head>

<!-- 
This is the front end of a plant finder app.
It allows you to search for plants and generate a formatted list
It uses the trefle API, available at https://trefle.io/
It also uses "materialize" css for styling.
-->

<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<title>Find Plants</title>

<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<!-- Compiled and minified CSS -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">

  
<link rel="stylesheet" href="styles.css">
<script type="text/javascript">


// when the form is submitted, run the search
let formSubmit = (e) => {
   event.preventDefault();
   let terms = document.getElementById("search").value;
   search(terms);
}

// runs a search for the given terms
// and trigger a rendering for each one
const search = (terms) => {
  document.getElementById("content").innerHTML = '';
  fetch('/PlantFinder/search/'+terms  )
    .then(response => response.json())
    .then(plants => {
        console.log(plants)
        for (i in plants.data){ 
          render(plants.data[i].id); 
        }
     })
    .catch(error => console.log('error', error));
}

// render the plant by fetching additional details
const render = (plantId) => {
  
  // fetch details about the plant
  fetch( '/PlantFinder/plant/'+plantId )
  .then( response => response.json() )
  .then( json => {

    console.log(json);
    
    // show the common name but only if there is one on record
    let theName = (json.data.common_name)?
      '<div class="card-action">'+
        '<a href="#">'+json.data.common_name+'</a>'+
      '</div>':'';

    // show a default icon if no image is provided.
    let theImg = 'plant.png';
    if (typeof json.data.image_url == "string"){
      // floristic doesnt have a valid cert so we will use plantnet instead
      theImg = json.data.image_url.replace("floristic", "plantnet");
    } 

    // Generate HTML for a plant listing.
    // See https://materializecss.com/cards.html
    document.getElementById("content").innerHTML +=
    '<div class="col s12 m7">'+
    '<h2 class="header">'+json.data.scientific_name+'</h2>'+
    '<div class="card horizontal">'+
      '<div class="card-image">'+
        '<img width="150" src="'+theImg+'">'+
      '</div>'+
      '<div class="card-stacked">'+
        '<div class="card-content">'+
          '<b>Family</b>: '+ json.data.main_species.family+'<br/>'+
          '<b>Genus</b>: '+ json.data.main_species.genus+'</p>'+
        '</div>'+
          theName +
      '</div>'+
    '</div>'+
  '</div>';

  })
 .catch(error => console.log('error', error));
}


</script>

</head>
<body>

  <!-- Navigation bar to hold search form-->
  <nav>
   <div class="nav-wrapper">
     <form onsubmit="formSubmit(this)">
       <div class="input-field">
         <input placeholder="Find a Plant"  id="search" type="search" required>
         <label class="label-icon" for="search"><i class="material-icons">search</i></label>
         <i class="material-icons">close</i>
       </div>
     </form>
   </div>
 </nav>

  <section id="content">
      <!--search results will be added here dynamically -->
  </section>

    <footer>
      Data supplied by the <a href="https://trefle.io">Trefle API</a>.
    </footer>
     <!-- Compiled and minified JavaScript -->
     <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>
